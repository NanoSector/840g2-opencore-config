# 840g1-opencore-config
OpenCore configuration for my Elitebook.

# OpenCore version tested with: 0.7.2
## macOS version tested with: 11.5.2
Please do not use this with any newer or older version as some options may no longer exist or be interpreted differently, or new options may be needed in order to successfully boot.

# Specs
- System: HP Elitebook 840 G2 (board id 198F)
- CPU: i5 5200U
- GPU: Intel HD Graphics 5500
- RAM: 16 GB Kingston 1600 MHz DDR3
- SSD: 256 GB Samsung 830
- Wifi: Intel Advanced-AC 7265
- Ethernet: Intel I218LM
- Audio: Realtek ALC280
- Card reader: Realtek RTS5227

# BIOS Settings (version 1.48)
## TODO: UPDATE THIS
Settings not specified are left on their default values or are unimportant.

- [ ] = unchecked
- [x] = checked

- Boot Options:
    - [ ] Fast Boot
    - [ ] All boot options except USB boot and Customized boot
    - [ ] Secure Boot
    - Boot mode: `UEFI Native (Without CSM)`
- Device Configurations
    - [ ] USB Legacy Support
    - [x] USB 3.0 (XHCI)
    - Video memory size: `64 MB`
    - [ ] Wake on USB
    - [x] VT-x
    - [ ] VT-d -> Could be left on, since the DisableIOMapper quirk is enabled in OpenCore.
    - Deep sleep: `Off`
- Built-In Device Options
    - [ ] Wireless Button State
    - [ ] LAN/WLAN switching
    - Wake on LAN: `Disable` -> System will instantly wake from sleep with this enabled.
- Port Options
    - [ ] Flash Media Reader -> Doesn't work anyway, see current issues below.

# OpenCore config noteworthy things
## TODO: UPDATE THIS

- SIP is completely enabled
- `ig-platform-id` is set to `0x0A260006` and the device-id is spoofed to `0x0412` for the HD 4400 to work like HD 4600.
- The system is set to play the startup beep/bong on its internal speaker. Drop the Resources folder from [OcBinaryData](https://github.com/acidanthera/OcBinaryData) in your EFI/OC folder. Strip out the excess files for languages you don't use for faster bootup times.
    - Lies! It doesn't currently do this. Keeping it here for future reference though.

## ScanPolicy enabled flags
### TODO: UPDATE THIS
ScanPolicy is set to a value of `2162947` or binary `001000010000000100000011`. This means the following flags are set:

- `OC_SCAN_FILE_SYSTEM_LOCK` (bit 0)
- `OC_SCAN_DEVICE_LOCK` (bit 1)
- `OC_SCAN_ALLOW_FS_APFS` (bit 8)
- `OC_SCAN_ALLOW_DEVICE_SATA` (bit 16)
- `OC_SCAN_ALLOW_DEVICE_USB` (bit 21)

Please refer to the OpenCore manual for the meaning of these flags. In short, these flags allow scanning of APFS partitions (for macOS) on SATA and USB drives only. The USB part should be temporary.

# ACPI edits
See the ACPI subfolder.

- `BATC`: Combines both the built-in and external batteries together in one device
- `BATM`: Overrides methods using both batteries which are renamed with ACPI patches
- `EC-LAPTOP`: Provides a laptop EC device (TODO: Check if necessary/even working?)
- `HPET`: Fixes some conflicting IRQs. Works together with a couple ACPI patches defined in config.plist
- `PLUG`: Sets `plugin-type` to 1, needed for AGPM and proper CPU power management.
- `PNLF`: Backlight patches, copied from WhateverGreen
- `SBUS-MCHC`: SMBus fixes
- `XOSI`: Overrides the OSI method to enable more Windows-only features

# Device Properties
## TODO: Update this
- `PciRoot(0x0)/Pci(0x1b,0x0)`: IDT 92HD91BXX
    - `layout-id`: `84`, used to tell AppleALC which layout ID to pick to get the onboard sound working.
- `PciRoot(0x0)/Pci(0x2,0x0)`: Intel HD Graphics 4400
    - `ig-platform-id`: `0x0A260006` (reversed)
- `PciRoot(0x0)/Pci(0x1c,0x3)/Pci(0x0,0x0)`: Broadcom BCM43224
    - `brcmfx-country`: `NL` to make optimal use out of the Broadcom card and to reduce possible interference with surrounding devices.

# Drivers
Not included in this repo, I use the following drivers:

- [AudioDxe](https://github.com/acidanthera/OpenCorePkg) TODO: Implement chime support
- FwRuntimeServices (in the OpenCore package)
- [HFSPlus](https://github.com/acidanthera/OcBinaryData/blob/master/Drivers/HfsPlus.efi)

# Kexts
Not included in this repo, I use the following kexts:

- [AirportItlwm](https://github.com/OpenIntelWireless/itlwm): Driver for Intel wireless
- [AppleALC](https://github.com/acidanthera/AppleALC): Used to get the onboard audio working
- [CPUFriend](https://github.com/acidanthera/CPUFriend): Power management data injection
- [ECEnabler](https://github.com/1Revenger1/ECEnabler): Battery status
- [IntelMausi](https://github.com/acidanthera/IntelMausi): Driver for the built-in Ethernet controller
- [Lilu](https://github.com/acidanthera/Lilu): Requirement for most other kexts in this list
- [RTCMemoryFixup](https://github.com/acidanthera/RTCMemoryFixup): Fixup kext for RTC memory
- [VirtualSMC](https://github.com/acidanthera/VirtualSMC): SMC emulator (+ SMCBatteryManager + SMCProcessor + SMCSuperIO)
- USBMap: Generated by [corpnewt's tool](https://github.com/corpnewt/usbmap)
- [VoodooPS2Controller](https://github.com/acidanthera/VoodooPS2): Base driver for the trackpad and keyboard
- [VoodooRMI & VoodooSMBus](https://github.com/VoodooSMBus/VoodooRMI): Synaptics touchpad driver
- [WhateverGreen](https://github.com/acidanthera/WhateverGreen): Required for proper functioning of the integrated graphics

# Current issues

## Inconsistent black screen after wake
Sometimes the system wakes to a black screen, waking it again a few more times fixes the issue randomly.

## SD card reader doesn't work
### TODO: UPDATE THIS FROM 840G1, not tested
It's a PCIe based card reader (RTS5227). Unlike USB card readers, this will not work out of the box.
Some drivers exist, the most recent one I could find being [Sinetek-rtsx](https://github.com/syscl/Sinetek-rtsx). 
However, that project seems dead and I have not (yet) tested this driver.

## Trackpoint doesn't work
I don't care, it's better this way. Probably requires an ACPI patch to get working.

## Wireless button is always orange
### TODO: CHECK ONCE BROADCOM CARD ARRIVES
Minor "issue", not sure how I could fix this. Wifi works fine so I'm probably not going to bother.
